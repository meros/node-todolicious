<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="todo-viewmodel"></dom-module>
<script>
  Polymer({
    is: 'todo-viewmodel',
    properties: {
     model: {
        type: Object,
        value: {
        selected: true,
        content: "testing",  
        bullets: [{
          content: "sub testing1",
          bullets: [{
            content: "sub sub testing1",
            bullets: []
          }, {
            selected: true, 
            content: "sub sub testing2",
            bullets: []
          }]
        }, {
          content: "sub testing2",
          bullets: []
        }]}}
    },
    
    getRootBulletModel: function() {
      var polymerThat = this;  	
        
      var BulletModel = function(node) {
        var that = this;
        polymerThat.addEventListener('selected-changed', function() {
          if (that.onSelectedChanged) {
            that.onSelectedChanged();  
          }
        });
        
        this.getContent = function() {
          return node.content;
        };
        
        this.getSubBulletModels = function() {
          return node.bullets.map(function(subNode) {
            return new BulletModel(subNode);
          });
        };   
        
        this.getIsSelected = function() {
          return node.selected === true;
        };     
      };
             
      return new BulletModel(this.model);
    },
    
    selectNext: function(forward) {
      var flatten = function(node) {
        var result = [node];
        
        node.bullets.forEach(function(subNode) {
          flatten(subNode).forEach(function(flattenedSubNodes) {
            result.push(flattenedSubNodes);
          });
        });     
        
        return result;
      };
      
      var findSelectedIndex = function(arr) {
        var result = null;
        arr.some(function(el, i) {
          return el.selected ? ((result = i), true) : false;
        });
          
        return result;
      }; 
      
      var flatBulletMap = flatten(this.model);
      var selected = findSelectedIndex(flatBulletMap);
      var newSelected = (selected + (forward?1:-1))% flatBulletMap.length;
      
      flatBulletMap[selected].selected = false;
      flatBulletMap[newSelected].selected = true;
      
      this.fire("selected-changed", {oldSelected: flatBulletMap[selected], newSelected: flatBulletMap[newSelected]})
    }
  });
</script>