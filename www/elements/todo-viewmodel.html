<link rel="import" href="../bower_components/polymer/polymer.html">
<dom-module id="todo-viewmodel"></dom-module>
<script>
	  /* global Polymer */
   Polymer({
      is: 'todo-viewmodel',
      properties: {
       model: {
          type: Object,
          notify: true,
          value: {
          selected: false,
          content: "testing",  
          bullets: [{
            content: "sub testing1",
            bullets: [{
              content: "sub sub testing1",
              bullets: []
            }, {
              selected: true, 
              content: "sub sub testing2",
              bullets: []
            }]
          }, {
            content: "sub testing2",
            bullets: []
          }]}}
      },
      
      getFlattenedArrayWithPaths: function() {
        var flatten = function(node, path) {
          var result = [node];
          node._path = path;
          
          node.bullets.forEach(function(subNode, index) {
            flatten(subNode, path + ".bullets." + index).forEach(function(flattenedSubNodes) {
              result.push(flattenedSubNodes);
            });
          });     
          
          return result;
        };
        
        return flatten(this.model, "model");
      },
      
      findSelectedIndexInFlattened: function(flattenedBulletMap) {
          var result = null;
          flattenedBulletMap.some(function(el, i) {
            return el.selected ? ((result = i), true) : false;
          });
            
          return result;
        },
      
      selectNext: function(forward) {
        var flatBulletMap = this.getFlattenedArrayWithPaths();
        var selected = this.findSelectedIndexInFlattened(flatBulletMap);
        var newSelected = (selected + (forward?1:-1)) % flatBulletMap.length;
        if (newSelected < 0) {
          newSelected = newSelected + flatBulletMap.length;
        }
        
        
        flatBulletMap[selected].selected = false;
        flatBulletMap[newSelected].selected = true;
        
        this.notifyPath(flatBulletMap[selected]._path + ".selected", flatBulletMap[selected].selected);
        this.notifyPath(flatBulletMap[newSelected]._path + ".selected", flatBulletMap[newSelected].selected);
      },
      
      splitBulletAtCaret: function() {
        var that = this;
        var flatBulletMap = this.getFlattenedArrayWithPaths();
        var selected = this.findSelectedIndexInFlattened(flatBulletMap);
        
        var beforeCaret = flatBulletMap[selected].content.substring(0, flatBulletMap[selected].caretPosition);
        var afterCaret = flatBulletMap[selected].content.substring(flatBulletMap[selected].caretPosition);
        
        var selectedBullet = flatBulletMap[selected];
        
        var path = flatBulletMap[selected]._path;
        var parentPath = path.replace(/\.bullets\.[0-9]+$/g, "");
        console.log(path);
        console.log(parentPath);
        
        var parent = this.get(parentPath);
        console.log(parent);
       var indexOfInsertedBullet = parent.bullets.indexOf(selectedBullet);
        
        //TODO: if has children, add to children instead
        this.set(selectedBullet._path + ".content", afterCaret);
        this.splice(parentPath + ".bullets", indexOfInsertedBullet, 0, {
            content: beforeCaret,
            bullets: []});
      }
      
    });
</script>